{"version":3,"sources":["../server.js"],"names":["express","require","app","server","createServer","moment","io","listen","message","chatRoom","users","connections","console","log","set","use","static","__dirname","get","req","res","render","sockets","on","socket","push","currentRoom","length","join","data","splice","indexOf","username","updateUsernames","find","room","err","messages","error","emit","in","user","created","newMsg","save","newRoom","leave","rooms"],"mappings":";;AAAA;;;AAGA,IAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,IAAMC,MAAMF,SAAZ;AACA,IAAMG,SAASF,QAAQ,MAAR,EAAgBG,YAAhB,CAA6BF,GAA7B,CAAf;AACA,IAAMG,SAASJ,QAAQ,QAAR,CAAf;AACA,IAAMK,KAAKL,QAAQ,WAAR,EAAqBM,MAArB,CAA4BJ,MAA5B,CAAX;AACA,IAAMK,UAAUP,QAAQ,mCAAR,CAAhB;AACA,IAAMQ,WAAWR,QAAQ,sCAAR,CAAjB;AACA,IAAMS,QAAQ,EAAd;AACA,IAAMC,cAAc,EAApB;;AAEAR,OAAOI,MAAP,CAAc,IAAd;;AAEAK,QAAQC,GAAR,CAAY,mBAAZ;AACAX,IAAIY,GAAJ,CAAQ,aAAR,EAAuB,KAAvB;AACAZ,IAAIa,GAAJ,CAAQf,QAAQgB,MAAR,CAAeC,YAAY,GAA3B,CAAR;;AAEAf,IAAIgB,GAAJ,CAAQ,GAAR,EAAY,UAAUC,GAAV,EAAeC,GAAf,EAAoB;AACxBA,QAAIC,MAAJ,CAAW,OAAX;AACH,CAFL;;AAII;AACJf,GAAGgB,OAAH,CAAWC,EAAX,CAAc,YAAd,EAA4B,UAASC,MAAT,EAAgB;AACxCb,gBAAYc,IAAZ,CAAiBD,MAAjB;AACA,QAAIE,cAAc,QAAlB;AACAd,YAAQC,GAAR,CAAY,iCAAZ,EAA+CF,YAAYgB,MAA3D;AACAH,WAAOI,IAAP,CAAYF,WAAZ;;AAEA;AACAF,WAAOD,EAAP,CAAU,YAAV,EAAwB,UAASM,IAAT,EAAc;AAClCnB,cAAMoB,MAAN,CAAapB,MAAMqB,OAAN,CAAcP,OAAOQ,QAArB,CAAb,EAA6C,CAA7C;AACAC;AACAtB,oBAAYmB,MAAZ,CAAmBnB,YAAYoB,OAAZ,CAAoBP,MAApB,CAAnB,EAAgD,CAAhD;AACAZ,gBAAQC,GAAR,CAAY,oCAAZ,EAAkDF,YAAYgB,MAA9D;AACH,KALD;;AAOA;AACAnB,YAAQ0B,IAAR,CAAa,EAACC,MAAMT,WAAP,EAAb,EAAiC,UAAUU,GAAV,EAAeC,QAAf,EAAyB;AACtD,YAAGD,GAAH,EAAQ,OAAOxB,QAAQ0B,KAAR,CAAcF,GAAd,CAAP;AACR9B,WAAGgB,OAAH,CAAWiB,IAAX,CAAgB,cAAhB,EAAgCF,QAAhC;AACH,KAHD;;AAKAb,WAAOD,EAAP,CAAU,UAAV,EAAsB,UAAUM,IAAV,EAAgB;AAC9BL,eAAOQ,QAAP,GAAkBH,IAAlB;AACAjB,gBAAQC,GAAR,CAAYW,OAAOQ,QAAnB;AACAtB,cAAMe,IAAN,CAAWD,OAAOQ,QAAlB;AACA1B,WAAGgB,OAAH,CAAWiB,IAAX,CAAgB,WAAhB,EAA6B7B,KAA7B;AACAuB;AACP,KAND;AAOA;AACAT,WAAOD,EAAP,CAAU,cAAV,EAA0B,UAASM,IAAT,EAAc;AACpCvB,WAAGkC,EAAH,CAAMd,WAAN,EAAmBa,IAAnB,CAAwB,aAAxB,EAAuC,EAAC/B,SAASqB,KAAKrB,OAAf,EAAwBiC,MAAMZ,KAAKY,IAAnC,EAAyCC,SAASb,KAAKa,OAAvD,EAAvC;AACA;AACA,YAAIC,SAAS,IAAInC,OAAJ,CAAa,EAAEiC,MAAMZ,KAAKY,IAAb,EAAmBjC,SAASqB,KAAKrB,OAAjC,EAA0C2B,MAAMT,WAAhD,EAAb,CAAb;;AAEA;AACAiB,eAAOC,IAAP,CAAY,UAAUR,GAAV,EAAeO,MAAf,EAAuB;AAC/B,gBAAIP,GAAJ,EAAS,OAAOxB,QAAQ0B,KAAR,CAAcF,GAAd,CAAP;AACTxB,oBAAQC,GAAR,CAAY,kBAAZ;AACH,SAHD;AAKH,KAXD;AAYAW,WAAOD,EAAP,CAAU,aAAV,EAAwB,UAASM,IAAT,EAAe;AACnCL,eAAOe,IAAP,CAAY,UAAZ,EAAuB,EAACJ,MAAMN,IAAP,EAAvB;AACA,YAAMgB,UAAU,IAAIpC,QAAJ,CAAa,EAAE0B,MAAMN,IAAR,EAAb,CAAhB;AACAgB,gBAAQD,IAAR,CAAa,UAAUR,GAAV,EAAeS,OAAf,EAAwB;AACjC,gBAAIT,GAAJ,EAAS,OAAOxB,QAAQ0B,KAAR,CAAcF,GAAd,CAAP;AACTxB,oBAAQC,GAAR,CAAY,iBAAZ,EAA+BgC,OAA/B;AACH,SAHD;AAIH,KAPD;AAQArB,WAAOD,EAAP,CAAU,eAAV,EAA2B,UAAUM,IAAV,EAAgB;AACvCL,eAAOsB,KAAP,CAAapB,WAAb;AACAA,sBAAcG,IAAd;AACAL,eAAOI,IAAP,CAAYC,IAAZ;AACArB,gBAAQ0B,IAAR,CAAa,EAACC,MAAMN,IAAP,EAAb,EAA0B,UAAUO,GAAV,EAAeC,QAAf,EAAyB;AAC/C,gBAAGD,GAAH,EAAQ,OAAOxB,QAAQ0B,KAAR,CAAcF,GAAd,CAAP;AACRZ,mBAAOe,IAAP,CAAY,cAAZ,EAA4BF,QAA5B;AACH,SAHD;AAIH,KARD;AASA;AACA5B,aAASyB,IAAT,CAAc,UAAUE,GAAV,EAAeW,KAAf,EAAsB;AAChC,YAAGX,GAAH,EAAQ,OAAOxB,QAAQ0B,KAAR,CAAcF,GAAd,CAAP;AACR9B,WAAGgB,OAAH,CAAWiB,IAAX,CAAgB,WAAhB,EAA6BQ,KAA7B;AACH,KAHD;;AAKA;AACA,aAASd,eAAT,GAA0B;AAClB3B,WAAGgB,OAAH,CAAWiB,IAAX,CAAgB,WAAhB,EAA6B7B,KAA7B;AACP;AAIJ,CAtED","file":"server.js","sourcesContent":["/**\r\n * Created by Kasper Terp on 21-02-2017.\r\n */\r\nconst express = require('express');\r\nconst app = express();\r\nconst server = require('http').createServer(app);\r\nconst moment = require('moment');\r\nconst io = require('socket.io').listen(server);\r\nconst message = require('./dist/Models/schema.server.model');\r\nconst chatRoom = require('./dist/Models/schema.chatrooms.model');\r\nconst users = [];\r\nconst connections = [];\r\n\r\nserver.listen(3000);\r\n\r\nconsole.log('Server running...');\r\napp.set('view engine', 'ejs');\r\napp.use(express.static(__dirname + '/'));\r\n\r\napp.get('/',function (req, res) {\r\n        res.render('index');\r\n    });\r\n\r\n    //connect\r\nio.sockets.on('connection', function(socket){\r\n    connections.push(socket);\r\n    let currentRoom = 'room 1';\r\n    console.log('Connected: %s sockets connected', connections.length);\r\n    socket.join(currentRoom);\r\n\r\n    // Disconnect\r\n    socket.on('disconnect', function(data){\r\n        users.splice(users.indexOf(socket.username), 1);\r\n        updateUsernames();\r\n        connections.splice(connections.indexOf(socket), 1);\r\n        console.log('Disconnected: %s sockets connected', connections.length);\r\n    });\r\n\r\n    //Getting messages for current default room, before the socket\r\n    message.find({room: currentRoom},function (err, messages) {\r\n        if(err) return console.error(err);\r\n        io.sockets.emit('get messages', messages);\r\n    });\r\n\r\n    socket.on('new user', function (data) {\r\n            socket.username = data;\r\n            console.log(socket.username);\r\n            users.push(socket.username);\r\n            io.sockets.emit('usernames', users);\r\n            updateUsernames();\r\n    });\r\n    // Send message\r\n    socket.on('send message', function(data){\r\n        io.in(currentRoom).emit('new message', {message: data.message, user: data.user, created: data.created});\r\n        // Create new message\r\n        let newMsg = new message ({ user: data.user, message: data.message, room: currentRoom });\r\n\r\n        // Insert to db\r\n        newMsg.save(function (err, newMsg) {\r\n            if (err) return console.error(err);\r\n            console.log(\"message is saved\");\r\n        });\r\n\r\n    });\r\n    socket.on('create room',function(data) {\r\n        socket.emit('new room',{room: data});\r\n        const newRoom = new chatRoom({ room: data});\r\n        newRoom.save(function (err, newRoom) {\r\n            if (err) return console.error(err);\r\n            console.log(\"room is saved :\", newRoom);\r\n        });\r\n    });\r\n    socket.on('selected room', function (data) {\r\n        socket.leave(currentRoom);\r\n        currentRoom = data;\r\n        socket.join(data);\r\n        message.find({room: data},function (err, messages) {\r\n            if(err) return console.error(err);\r\n            socket.emit('get messages', messages);\r\n        });\r\n    });\r\n    //get and emit chatrooms from mongo\r\n    chatRoom.find(function (err, rooms) {\r\n        if(err) return console.error(err);\r\n        io.sockets.emit('get rooms', rooms);\r\n    });\r\n\r\n    // Update usernames\r\n    function updateUsernames(){\r\n            io.sockets.emit('get users', users);\r\n    }\r\n\r\n\r\n\r\n});\r\n\r\n"]}